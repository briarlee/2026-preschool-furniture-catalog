<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç”Ÿæˆå›¾ç‰‡å‘½åå¯¹ç…§è¡¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 40px; background: #f5f7fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #667eea; margin-bottom: 10px; }
        p { color: #718096; line-height: 1.6; }
        .btn { background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 20px 0; }
        .btn:hover { background: #5a67d8; }
        .stats { background: #f7fafc; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .stats h3 { margin: 0 0 10px 0; color: #2d3748; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .stat-label { color: #718096; }
        .stat-value { font-weight: 600; color: #2d3748; }
        .note { background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #f59e0b; }
        .note h4 { margin: 0 0 10px 0; color: #92400e; }
        .note ul { margin: 0; padding-left: 20px; color: #78350f; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ å›¾ç‰‡å‘½åå¯¹ç…§è¡¨ç”Ÿæˆå™¨</h1>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œç”Ÿæˆäº§å“å›¾ç‰‡å‘½åå¯¹ç…§è¡¨ï¼ˆExcelæ ¼å¼ï¼‰ï¼Œæ–¹ä¾¿ä½ æŒ‰è§„åˆ™å‘½åå›¾ç‰‡æ–‡ä»¶ã€‚</p>

        <div class="stats" id="stats"></div>

        <div class="note">
            <h4>ğŸ“ å‘½åè§„åˆ™è¯´æ˜</h4>
            <ul>
                <li><strong>å›¾ç‰‡IDæ ¼å¼</strong>ï¼šåˆ†ç±»å‰ç¼€ + åºå·ï¼Œå¦‚ <code>seating_001</code>ã€<code>table_015</code></li>
                <li><strong>å”¯ä¸€æ€§ä¿è¯</strong>ï¼šæ¯ä¸ªäº§å“éƒ½æœ‰å”¯ä¸€IDï¼Œä¸ä¼šé‡å¤</li>
                <li><strong>å›¾ç‰‡æ ¼å¼</strong>ï¼šæ”¯æŒ .jpg æˆ– .png</li>
                <li><strong>å­˜æ”¾ä½ç½®</strong>ï¼šå°†å›¾ç‰‡æ”¾å…¥ <code>images/</code> æ–‡ä»¶å¤¹</li>
            </ul>
        </div>

        <button class="btn" onclick="generateExcel()">ğŸ“Š ç”Ÿæˆå¯¹ç…§è¡¨Excel</button>

        <div id="result"></div>
    </div>

    <script>
        // ä»ä¸»é¡µé¢å¼•ç”¨äº§å“æ•°æ®
        const productScript = document.createElement('script');
        productScript.src = 'äº§å“ç›®å½•.html';

        // è¿™é‡Œç›´æ¥å†…åµŒè¯»å–ï¼Œé€šè¿‡fetchè·å–
        let products = [];

        async function loadProducts() {
            try {
                const response = await fetch('äº§å“ç›®å½•.html');
                const html = await response.text();
                // æå–productsæ•°ç»„
                const match = html.match(/const products = \[([\s\S]*?)\];/);
                if (match) {
                    // ä½¿ç”¨evalè§£æï¼ˆä»…é™æœ¬åœ°ä½¿ç”¨ï¼‰
                    products = eval('[' + match[1] + ']');
                    analyzeData();
                }
            } catch(e) {
                console.error('åŠ è½½äº§å“æ•°æ®å¤±è´¥', e);
                document.getElementById('stats').innerHTML = '<p style="color:red;">åŠ è½½äº§å“æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿ä¸äº§å“ç›®å½•.htmlåœ¨åŒä¸€æ–‡ä»¶å¤¹</p>';
            }
        }

        loadProducts();

        // ç”Ÿæˆå”¯ä¸€å›¾ç‰‡ID
        function generateImageId(product, index, categoryCounters) {
            const category = product.category || 'other';
            if (!categoryCounters[category]) {
                categoryCounters[category] = 0;
            }
            categoryCounters[category]++;
            const num = String(categoryCounters[category]).padStart(3, '0');
            return `${category}_${num}`;
        }

        // ç»Ÿè®¡æ•°æ®
        function analyzeData() {
            const stats = {
                total: products.length,
                noModel: 0,
                noCode: 0,
                categories: {}
            };

            products.forEach(p => {
                if (!p.model) stats.noModel++;
                if (!p.code) stats.noCode++;
                stats.categories[p.category] = (stats.categories[p.category] || 0) + 1;
            });

            // æ˜¾ç¤ºç»Ÿè®¡
            let html = '<h3>ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>';
            html += `<div class="stat-row"><span class="stat-label">äº§å“æ€»æ•°</span><span class="stat-value">${stats.total}</span></div>`;
            html += `<div class="stat-row"><span class="stat-label">ç¼ºå°‘å‹å·</span><span class="stat-value">${stats.noModel}</span></div>`;
            html += `<div class="stat-row"><span class="stat-label">ç¼ºå°‘ç¼–å·</span><span class="stat-value">${stats.noCode}</span></div>`;
            html += '<div class="stat-row"><span class="stat-label">åˆ†ç±»åˆ†å¸ƒ</span><span class="stat-value"></span></div>';

            Object.entries(stats.categories).sort((a,b) => b[1] - a[1]).forEach(([cat, count]) => {
                html += `<div class="stat-row" style="padding-left:20px;"><span class="stat-label">${cat}</span><span class="stat-value">${count}</span></div>`;
            });

            document.getElementById('stats').innerHTML = html;
        }

        // ç”ŸæˆExcelå¯¹ç…§è¡¨
        async function generateExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('å›¾ç‰‡å‘½åå¯¹ç…§è¡¨');

            // è®¾ç½®åˆ—
            worksheet.columns = [
                { header: 'å›¾ç‰‡ID', key: 'imageId', width: 18 },
                { header: 'å›¾ç‰‡æ–‡ä»¶å', key: 'fileName', width: 22 },
                { header: 'äº§å“åç§°', key: 'name', width: 40 },
                { header: 'å‹å·', key: 'model', width: 15 },
                { header: 'ç¼–å·', key: 'code', width: 15 },
                { header: 'åˆ†ç±»', key: 'category', width: 12 },
                { header: 'æ˜¯å¦ä¸»ç›®å½•', key: 'main', width: 12 },
                { header: 'å›¾ç‰‡çŠ¶æ€', key: 'status', width: 12 }
            ];

            // è¡¨å¤´æ ·å¼
            worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
            worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.getRow(1).height = 25;
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

            // ç”Ÿæˆæ•°æ®
            const categoryCounters = {};
            products.forEach((p, idx) => {
                const imageId = generateImageId(p, idx, categoryCounters);
                const row = worksheet.addRow({
                    imageId: imageId,
                    fileName: imageId + '.jpg',
                    name: p.name,
                    model: p.model || '(æ— )',
                    code: p.code || '(æ— )',
                    category: p.category,
                    main: p.main ? 'æ˜¯' : '',
                    status: 'å¾…æ·»åŠ '
                });

                // äº¤æ›¿è¡ŒèƒŒæ™¯è‰²
                if (idx % 2 === 0) {
                    row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF7FAFC' } };
                }

                // ä¸»ç›®å½•äº§å“é«˜äº®
                if (p.main) {
                    row.getCell(7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC6F6D5' } };
                }
            });

            // æ·»åŠ è¾¹æ¡†
            worksheet.eachRow((row, rowNumber) => {
                row.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFE2E8F0' } },
                        left: { style: 'thin', color: { argb: 'FFE2E8F0' } },
                        bottom: { style: 'thin', color: { argb: 'FFE2E8F0' } },
                        right: { style: 'thin', color: { argb: 'FFE2E8F0' } }
                    };
                    cell.alignment = { vertical: 'middle' };
                });
            });

            // å†»ç»“é¦–è¡Œ
            worksheet.views = [{ state: 'frozen', ySplit: 1 }];

            // ä¸‹è½½
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'äº§å“å›¾ç‰‡å‘½åå¯¹ç…§è¡¨.xlsx';
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('result').innerHTML = `
                <div style="background:#C6F6D5;padding:20px;border-radius:8px;margin-top:20px;">
                    <strong>âœ… å¯¼å‡ºæˆåŠŸï¼</strong><br><br>
                    <b>ä¸‹ä¸€æ­¥æ“ä½œï¼š</b><br>
                    1. æ‰“å¼€ä¸‹è½½çš„Excelæ–‡ä»¶<br>
                    2. æŒ‰ç…§"å›¾ç‰‡æ–‡ä»¶å"åˆ—å‘½åä½ çš„å›¾ç‰‡<br>
                    3. å°†å›¾ç‰‡æ”¾å…¥ <code>images/</code> æ–‡ä»¶å¤¹<br>
                    4. å®Œæˆåå‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šæ›´æ–°äº§å“ç›®å½•ä»£ç 
                </div>
            `;
        }

        // åˆå§‹åŒ–
        analyzeData();
    </script>
</body>
</html>
